<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>{% block title %}CivicFix - Solve Together{% endblock %}</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet"
            href="{{ url_for('static', filename='css/base.css') }}">
        <link rel="stylesheet"
            href="{{ url_for('static', filename='css/home.css') }}">
        <link
            href="https://unpkg.com/aos@2.3.4/dist/aos.css"
            rel="stylesheet" />
    </head>
    <body class="home">
        <!-- NAVBAR (single navbar) -->
        <nav class="navbar" id="navbar" data-aos="fade-down">
            <a href="{{ url_for('home') }}">CivicFix</a>
            <ul class="nav-links">
                <li><a href="#feed">Feed</a></li>
                <li><a href="/add_problem">Report Issue</a></li>
                {% if session.get("user_id") %}
                <!-- Logged in -->
                <li class="account-menu">
                    <button class="account-btn">
                        Profile
                    </button>
                    <div class="account-dropdown">
                        <a href="/profile">üë§{{ session.get("user_name",
                            "Account") }}</a>
                        <a href="/my_issues">My Issues</a>
                        <a href="/logout" class="logout">Logout</a>
                    </div>
                </li>
                {% else %}
                <!-- Not logged in -->
                <li><a href="/login">Login</a></li>
                <li><a href="/register">Register</a></li>
                {% endif %}
                <button class="theme-toggle" id="themeToggle"
                    aria-label="Toggle theme">
                    <img
                        src="{{ url_for('static', filename='images/moon.svg') }}"
                        alt="Dark mode"
                        class="theme-icon moon-icon">
                    <img
                        src="{{ url_for('static', filename='images/sun.svg') }}"
                        alt="Light mode"
                        class="theme-icon sun-icon">
                </button>
            </ul>
        </nav>

        <!-- HERO -->
        <header class="hero">
            <div class="hero-content" data-aos="fade-up">
                <h1>Report Civic Issues</h1>
                <p>Make problems visible in your local area</p>
                {% if session.get("user_id") %}
                <a href="{{ url_for('add_problem') }}"
                    class="btn-primary">Report an Issue</a>
                {% else %}
                <a href="{{ url_for('login') }}" class="btn-primary">Login to
                    Report</a>
                {% endif %}
            </div>
        </header>
        <section id="feed-section">
            <div class="container" id="feed">
                <div class="feed-header" data-aos="fade-up">
                    <h1>Problems in Your Area</h1>
                    {% if not session.get("user_id") %}
                    <p class="guest-hint">Login to vote or report issues.</p>
                    {% endif %}
                </div>

                <div class="feed-container">

                    {% if problems|length == 0 %}
                    <p class="empty-state">No problems reported yet.</p>
                    {% endif %}

                    {% for problem in problems %}
                    <div class="problem-card"
                        data-aos="fade-up"
                        data-aos-delay="{{ loop.index0 * 100 }}"
                        data-aos-once="true">

                        <!-- CARD HEADER -->
                        <div class="card-header">
                            <span class="category-tag">{{ problem.category
                                }}</span>

                            <span
                                class="status-badge status-{{ problem.status|lower }}">
                                {{ problem.status }}
                            </span>
                            <span>{% if problem.is_verified %}
                                <span class="verified-badge">‚úî Verified</span>
                                {% endif %}</span>
                            <span class="priority-badge">
                                üî• Priority {{ problem.priority_score }}
                            </span>
                        </div>

                        <!-- ADMIN STATUS UPDATE -->
                        {% if session.get("user_email") == admin_email %}
                        <form class="admin-status-form"
                            method="POST"
                            action="/update_status/{{ problem._id }}">
                            <select name="status">
                                <option {% if problem.status == "Pending"
                                    %}selected{% endif %}>
                                    Pending
                                </option>
                                <option {% if problem.status == "Acknowledged"
                                    %}selected{% endif %}>
                                    Acknowledged
                                </option>
                                <option {% if problem.status == "Resolved"
                                    %}selected{% endif %}>
                                    Resolved
                                </option>
                            </select>
                            <button type="submit">Update</button>
                        </form>
                        {% endif %}

                        <!-- IMAGE -->
                        {% if problem.image %}
                        <img
                            src="{{ url_for('static', filename=problem.image) }}"
                            class="problem-img">
                        {% endif %}

                        <!-- BODY -->
                        <div class="card-body">
                            <p class="description">{{ problem.description }}</p>
                            <div class="location-info">
                                üìç {{ problem.location.area_name }}
                            </div>
                        </div>

                        <!-- FOOTER -->
                        <div class="card-footer">
                            <button class="vote-btn"
                                data-id="{{ problem._id }}">
                                ‚ñ≤ <span>{{ problem.votes }} Votes</span>
                            </button>
                            <button class="share-btn">
                                Share</button>
                            {% if problem.is_verified and
                            problem.is_top_priority %}
                            <a href="/export/{{ problem._id }}"
                                class="share-btn">
                                üìãExport Complaint
                            </a>
                            {% else %}
                            <span class="export-hint">
                                Export available for verified high-priority
                                issues
                            </span>
                            {% endif %}

                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>
        <div id="toast-container"></div>
        <script src="{{ url_for('static', filename='js/base.js') }}"></script>
        <script src="{{ url_for('static', filename='js/home.js') }}"></script>
        <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    </body>
</html>
